<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Sequential Testing Experiment with Conjugate Models · BayesianExperiments.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">BayesianExperiments.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../examples/">Getting Started</a></li><li><a class="tocitem" href="../../api/">API</a></li><li><span class="tocitem">Tutorials</span><ul><li class="is-active"><a class="tocitem" href>Sequential Testing Experiment with Conjugate Models</a><ul class="internal"><li><a class="tocitem" href="#Two-Models"><span>Two Models</span></a></li></ul></li><li><a class="tocitem" href="../type_s_error/">Type S Error in Fixed Horizon and Sequential Testing Experiment</a></li><li><a class="tocitem" href="../bayes_factor_optional_stopping/">Bayes Factor Experiment with Optional Stopping</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Sequential Testing Experiment with Conjugate Models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Sequential Testing Experiment with Conjugate Models</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/rakutentech/BayesianExperiments.jl/blob/master/docs/src/tutorials/sequential_testing_conjugate_models.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Sequential-Testing-Experiment-with-Conjugate-Models"><a class="docs-heading-anchor" href="#Sequential-Testing-Experiment-with-Conjugate-Models">Sequential Testing Experiment with Conjugate Models</a><a id="Sequential-Testing-Experiment-with-Conjugate-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Sequential-Testing-Experiment-with-Conjugate-Models" title="Permalink"></a></h1><pre><code class="language-julia">using Random 
using Plots

using BayesianExperiments</code></pre><h2 id="Two-Models"><a class="docs-heading-anchor" href="#Two-Models">Two Models</a><a id="Two-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Two-Models" title="Permalink"></a></h2><p>We want to compare two variants with ratios. For example, we have a new UI design and want to compare its CTR (click-through-rate) to the CTR of the existing design. In this case we can create two Bernoulli models to model the CTR&#39;s of each variant. </p><p>A Bernoulli model is a model with Bernoulli distribution as the likelihood and Beta distribution as the prior. In the beginning, we set <span>$\alpha=10$</span> and <span>$\beta=90$</span> as parameters of the prior. (We will talk about the impact of priors and how to choose a &quot;proper&quot; prior for you experiment in details later).</p><pre><code class="language-julia">α = 1
β = 1
modelA = ConjugateBernoulli(α, β)
modelB = ConjugateBernoulli(α, β)
models = [modelA, modelB]
modelnames = [&quot;control&quot;, &quot;variant 1&quot;];</code></pre><p>We want to use &quot;expected loss&quot; as the key metric for our decision, and a &quot;threshold of caring&quot; of 0.0001 as the stopping rule of our experiment. An expected loss can be think as the &quot;average&quot; loss that we will get if our decision is wrong. It depends on how likely our decision is wrong, and how much loss we will get when our decision is wrong.</p><pre><code class="language-julia">thresh = 1e-4
stoppingrule = ExpectedLossThresh(thresh);</code></pre><p>An experiment is a combination of underlying models and the stopping rule that we chose before.</p><pre><code class="language-julia">experiment = ExperimentAB(models, stoppingrule, modelnames=modelnames);</code></pre><p>Now we start to collect real data in our online experiment. Let&#39;s make some assumptions to demonstrate the idea:</p><ol><li>The underlying data generating distributions follow Bernoulli distributions with parameters 0.01 and 0.0102. And That means our new design has 2% higher CTR than the current one.</li><li>We use <span>$20%$</span> of the total traffic to test the new design. At each day, we can collect 4000 and 1000 observations for &quot;control&quot; and &quot;variant 1&quot;. </li></ol><p>We will update the models as we collect more data and monitor the change of our expected loss. Our rule is quite simple: if the expected loss of one group is below the threshold, we can stop the experiment and make decision. And we will collect for maximum 15 days and declare no winner if there is no group with expected loss below the threshold.</p><pre><code class="language-julia">max_days = 15

Random.seed!(12)
expected_losses = Vector{Float64}[]
day = 0
for _ = 1:max_days
    day += 1
    # we collect data every day
    dataA = rand(Bernoulli(0.0100), 4000)
    dataB = rand(Bernoulli(0.0102), 1000)
    
    # convert data into statistics
    statsA = BernoulliStatistics(dataA)
    statsB = BernoulliStatistics(dataB)
    
    # update the models in the experiment with the statistics
    update!(experiment, [statsA, statsB])
    
    # calculate the metrics (expected loss)
    # this step is optional, for visualization below
    _, losses = metrics(experiment)
    push!(expected_losses, losses)
    
    # select winner, get &quot;nothing&quot; if there is no winner
    winner = decide!(experiment)
    
    # stop the experiment if we already find a winner
    if winner !== nothing
        break
    end
end</code></pre><p>Now we can visualize the expected losses over days. We can see the expected loss of &quot;variant 1&quot; is decreasing over days. And at day 7 we find its expected loss is below the threshold in our stopping rule.</p><pre><code class="language-julia">plot(collect(1:day), catbyrow(expected_losses), 
    title=&quot;Expected Losses&quot;,
    label=[&quot;Control&quot; &quot;Variant 1&quot;],
    legend=:topleft,)
hline!([thresh], color=:grey, line=:dash, label=:none)
annotate!(1.5, 0.0002, text(&quot;Threshold&quot;, 10))</code></pre><p><img src="../sequential_testing_conjugate_models_files/sequential_testing_conjugate_models_12_0.svg" alt="svg"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../api/">« API</a><a class="docs-footer-nextpage" href="../type_s_error/">Type S Error in Fixed Horizon and Sequential Testing Experiment »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 20 March 2021 02:09">Saturday 20 March 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
