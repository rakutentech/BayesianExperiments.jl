<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Bayes Factor Experiment with Optional Stopping · BayesianExperiments.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">BayesianExperiments.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../examples/">Getting Started</a></li><li><a class="tocitem" href="../../api/">API</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../sequential_testing_conjugate_models/">Sequential Testing Experiment with Conjugate Models</a></li><li><a class="tocitem" href="../type_s_error/">Type S Error in Fixed Horizon and Sequential Testing Experiment</a></li><li class="is-active"><a class="tocitem" href>Bayes Factor Experiment with Optional Stopping</a><ul class="internal"><li><a class="tocitem" href="#Case-when-alternative-\\delta-0"><span>Case when alternative <span>$\delta = 0$</span></span></a></li><li><a class="tocitem" href="#Case-when-alternative-\\delta-0-2"><span>Case when alternative <span>$\delta &gt; 0$</span></span></a></li><li><a class="tocitem" href="#Evaluate-the-simulation-result-with-Type-I-and-II-Error-and-FDR"><span>Evaluate the simulation result with Type I &amp; II Error and FDR</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Bayes Factor Experiment with Optional Stopping</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Bayes Factor Experiment with Optional Stopping</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/rakutentech/BayesianExperiments.jl/blob/master/docs/src/tutorials/bayes_factor_optional_stopping.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Bayes-Factor-Experiment-with-Optional-Stopping"><a class="docs-heading-anchor" href="#Bayes-Factor-Experiment-with-Optional-Stopping">Bayes Factor Experiment with Optional Stopping</a><a id="Bayes-Factor-Experiment-with-Optional-Stopping-1"></a><a class="docs-heading-anchor-permalink" href="#Bayes-Factor-Experiment-with-Optional-Stopping" title="Permalink"></a></h1><pre><code class="language-julia">using ProgressMeter: @showprogress
using DataFrames

using PrettyTables
using Plots
using Random
using BayesianExperiments

# number of columns in a dataframe to show 
ENV[&quot;COLUMNS&quot;] = 200;</code></pre><p>Optional stopping refers to the practice of peeking at data and make decision whether or not to continue an experiment. Such practice is usually prohibited in the frequentist AB testing framework. By using simulation-based result, <strong>Rouder (2014)</strong>[2] showed that a Bayes factor experiment with optional stopping can be valid with proper interpretation of the Bayesian quantities. </p><p>This notebook follows the examples in <strong>Schönbrodt et al. (2016)</strong>[1] to conduct the error analysis of Bayes factor based experiment with optional stopping.</p><p>The simulation will be conducted by following steps:</p><ol><li>Choose a threshold of Bayes factor for decision making. For example, if the threshold is set to 10, when a Bayes factor of <span>$\text{BF}_{10}$</span> is larger than 10, or less than 1/10, we decide we have collected enough evidence and stop the experiment.</li><li>Choose a prior distribituion for the effect size under <span>$H_1$</span>. We will use the <code>StudentTEffectSize</code> model in the package. You can check the definition of <code>NormalEffectSize</code> model from the docstring by typing <code>?NormalEffectSize</code>.</li><li>Run a minimum number of steps (20 as the same in the paper), increase the sample size. Compute the bayes factor at each step.</li><li>As soon as the bayes factor value reached or exceeded the one of the thresholds as set in (1), or the maximum number of steps is reached, we will stop the experiment.</li></ol><p>Some constants used in the simulation:</p><ul><li>Number of simulations: 5000</li><li>Minimum number of steps: 20</li></ul><p>The simulation function can be quickly created based on our package:</p><pre><code class="language-julia">function simulate(δ, n, σ0; r=0.707, thresh=9, minsample=20)
    # we will use two-sided decision rule for bayes factor
    rule = TwoSidedBFThresh(thresh)
    
    # the prior distribution of effect size,
    # r is the standard deviation
    model = StudentTEffectSize(r=r)
    
    # setup the experiment
    experiment = ExperimentBF(model=model, rule=rule)
    
    # create a sample with size n, the effect size is 
    # specified as δ
    xs = rand(Normal(δ, 1), n)
    
    i = 0
    # specify the stopping condition
    while (i &lt; n) &amp; (experiment.winner === nothing)
        i += 1
        
        # if minimum number of sample is not reached, 
        # keep collecting data
        if i &lt; minsample
            continue
        end
        
        stats = NormalStatistics(xs[1:i])
        experiment.stats = stats
        decide!(experiment)
    end
    experiment
end

# df table print helper
printtable(df) = pretty_table(df, tf=tf_markdown, nosubheader=true, header_crayon=Crayon(bold=:false))</code></pre><pre><code class="language-none">printtable (generic function with 1 method)</code></pre><h2 id="Case-when-alternative-\\delta-0"><a class="docs-heading-anchor" href="#Case-when-alternative-\\delta-0">Case when alternative <span>$\delta = 0$</span></a><a id="Case-when-alternative-\\delta-0-1"></a><a class="docs-heading-anchor-permalink" href="#Case-when-alternative-\\delta-0" title="Permalink"></a></h2><p>When alternative <span>$\delta &gt; 0$</span>, the error rate relates to the false positive rate. </p><pre><code class="language-julia">#deltas = collect(range(0, 1.5, step=0.2));
delta = 0.0
rs = [0.707, 1.0, 1.414];
threshs = [3, 5, 7, 10];
totalnum = length(rs)*length(threshs);

paramsgrid = reshape(collect(Base.Iterators.product(rs, threshs)), (totalnum, 1));
paramsgrid = [(r=r, thresh=thresh) for (r, thresh) in paramsgrid];
@show length(paramsgrid);</code></pre><pre><code class="language-none">length(paramsgrid) = 12</code></pre><pre><code class="language-julia">n =  1000
ns = 5000
minsample = 20

sim_result1 = DataFrame(
    delta=Float64[], 
    r=Float64[], 
    thresh=Float64[], 
    num_sim=Int64[], 
    num_null=Int64[], 
    num_alt=Int64[],
    err_rate=Float64[], 
    avg_sample_size=Int64[])

@showprogress for params in paramsgrid
    delta = 0
    r = params.r
    thresh = params.thresh
    winners = []
    samplesizes = []
    for _ in 1:ns
        experiment = simulate(delta, n, r, thresh=thresh, minsample=minsample)
        push!(winners, experiment.winner)
        push!(samplesizes, experiment.stats.n)
    end
    
    num_null = sum(winners .== &quot;null&quot;)
    num_alt = sum(winners .== &quot;alternative&quot;)
    
    err_rate = num_alt/ns
    avg_sample_size = mean(samplesizes)
    push!(sim_result1, (delta, r, thresh, ns, num_null, num_alt, err_rate, convert(Int64, round(avg_sample_size))))
end</code></pre><pre><code class="language-none">Progress: 100%|█████████████████████████████████████████| Time: 0:00:58</code></pre><pre><code class="language-julia">printtable(sim_result1)</code></pre><pre><code class="language-none">| delta |     r | thresh | num_sim | num_null | num_alt | err_rate | avg_sample_size |
|-------|-------|--------|---------|----------|---------|----------|-----------------|
|   0.0 | 0.707 |    3.0 |    5000 |     4689 |     311 |   0.0622 |              24 |
|   0.0 |   1.0 |    3.0 |    5000 |     4662 |     338 |   0.0676 |              24 |
|   0.0 | 1.414 |    3.0 |    5000 |     4698 |     302 |   0.0604 |              24 |
|   0.0 | 0.707 |    5.0 |    5000 |     4712 |     288 |   0.0576 |              47 |
|   0.0 |   1.0 |    5.0 |    5000 |     4718 |     282 |   0.0564 |              48 |
|   0.0 | 1.414 |    5.0 |    5000 |     4688 |     311 |   0.0622 |              49 |
|   0.0 | 0.707 |    7.0 |    5000 |     4753 |     238 |   0.0476 |             101 |
|   0.0 |   1.0 |    7.0 |    5000 |     4777 |     218 |   0.0436 |              99 |
|   0.0 | 1.414 |    7.0 |    5000 |     4765 |     227 |   0.0454 |             102 |
|   0.0 | 0.707 |   10.0 |    5000 |     4752 |     181 |   0.0362 |             210 |
|   0.0 |   1.0 |   10.0 |    5000 |     4729 |     210 |    0.042 |             206 |
|   0.0 | 1.414 |   10.0 |    5000 |     4745 |     191 |   0.0382 |             208 |</code></pre><h2 id="Case-when-alternative-\\delta-0-2"><a class="docs-heading-anchor" href="#Case-when-alternative-\\delta-0-2">Case when alternative <span>$\delta &gt; 0$</span></a><a class="docs-heading-anchor-permalink" href="#Case-when-alternative-\\delta-0-2" title="Permalink"></a></h2><p>We create a grid of combinations of all parameters.</p><pre><code class="language-julia">deltas = collect(range(0.1, 1.0, step=0.2));
rs = [0.707, 1.0, 1.414];
threshs = [3, 5, 7, 10];
totalnum = length(deltas)*length(rs)*length(threshs);

paramsgrid = reshape(collect(Base.Iterators.product(deltas, rs, threshs)), (totalnum, 1));
paramsgrid = [(delta=delta, r=r, thresh=thresh) for (delta, r, thresh) in paramsgrid]
@show length(paramsgrid);
@show paramsgrid[1:5];</code></pre><pre><code class="language-none">length(paramsgrid) = 60
paramsgrid[1:5] = NamedTuple{(:delta, :r, :thresh),Tuple{Float64,Float64,Int64}}[(delta = 0.1, r = 0.707, thresh = 3), (delta = 0.3, r = 0.707, thresh = 3), (delta = 0.5, r = 0.707, thresh = 3), (delta = 0.7, r = 0.707, thresh = 3), (delta = 0.9, r = 0.707, thresh = 3)]</code></pre><p>The simulation is similar to the <span>$\delta=0$</span> case. When alternative <span>$\delta &gt; 0$</span>, the error rate relates to the false negative evidence.</p><pre><code class="language-julia">n =  1000
ns = 5000
minsample = 20

sim_result2 = DataFrame(
    delta=Float64[], 
    r=Float64[], 
    thresh=Float64[], 
    num_sim=Int64[], 
    num_null=Int64[], 
    num_alt=Int64[],
    err_rate=Float64[], 
    avg_sample_size=Int64[])

@showprogress for params in paramsgrid
    delta=params.delta
    r = params.r
    thresh = params.thresh
    winners = []
    samplesizes = []
    for _ in 1:ns
        experiment = simulate(delta, n, r, thresh=thresh, minsample=minsample)
        push!(winners, experiment.winner)
        push!(samplesizes, experiment.stats.n)
    end
    
    num_null = sum(winners .== &quot;null&quot;)
    num_alt = sum(winners .== &quot;alternative&quot;)
    err_rate = 1-num_alt/ns
    avg_sample_size = mean(samplesizes)
    push!(sim_result2, (delta, r, thresh, ns, num_null, num_alt, 
            err_rate, convert(Int64, round(avg_sample_size))))
end</code></pre><pre><code class="language-none">Progress: 100%|█████████████████████████████████████████| Time: 0:02:31</code></pre><p>Simulation result when <span>$\delta=0.5$</span></p><pre><code class="language-julia">sim_result2 |&gt;
    df -&gt; filter(x-&gt;x.delta==0.5, df)|&gt;
    df -&gt; sort(df, [:delta, :r]) |&gt;
    printtable</code></pre><pre><code class="language-none">| delta |     r | thresh | num_sim | num_null | num_alt | err_rate | avg_sample_size |
|-------|-------|--------|---------|----------|---------|----------|-----------------|
|   0.5 | 0.707 |    3.0 |    5000 |      694 |    4306 |   0.1388 |              26 |
|   0.5 | 0.707 |    5.0 |    5000 |       82 |    4918 |   0.0164 |              33 |
|   0.5 | 0.707 |    7.0 |    5000 |        0 |    5000 |      0.0 |              36 |
|   0.5 | 0.707 |   10.0 |    5000 |        0 |    5000 |      0.0 |              39 |
|   0.5 |   1.0 |    3.0 |    5000 |      674 |    4326 |   0.1348 |              25 |
|   0.5 |   1.0 |    5.0 |    5000 |       90 |    4910 |    0.018 |              33 |
|   0.5 |   1.0 |    7.0 |    5000 |        3 |    4997 |   0.0006 |              37 |
|   0.5 |   1.0 |   10.0 |    5000 |        0 |    5000 |      0.0 |              40 |
|   0.5 | 1.414 |    3.0 |    5000 |      746 |    4254 |   0.1492 |              26 |
|   0.5 | 1.414 |    5.0 |    5000 |       84 |    4916 |   0.0168 |              34 |
|   0.5 | 1.414 |    7.0 |    5000 |        0 |    5000 |      0.0 |              36 |
|   0.5 | 1.414 |   10.0 |    5000 |        0 |    5000 |      0.0 |              40 |</code></pre><h2 id="Evaluate-the-simulation-result-with-Type-I-and-II-Error-and-FDR"><a class="docs-heading-anchor" href="#Evaluate-the-simulation-result-with-Type-I-and-II-Error-and-FDR">Evaluate the simulation result with Type I &amp; II Error and FDR</a><a id="Evaluate-the-simulation-result-with-Type-I-and-II-Error-and-FDR-1"></a><a class="docs-heading-anchor-permalink" href="#Evaluate-the-simulation-result-with-Type-I-and-II-Error-and-FDR" title="Permalink"></a></h2><p>As pointed out by [2], we can evaluate the simulation result from the perspective of false discovery rate. Here we assume there is a 50-50 chance that the data is from either the null model or alternative model. </p><p>We can merge the two simulations results by the prior standard deviation <span>$r$</span> and threshold of bayes factor. In the merged dataframe, each row represents a simulation with the 5000 samples from the null model and 5000 samples from the alternative model with the corresponding parameters (<span>$r$</span>, <span>$thresh$</span>, <span>$\delta_1$</span>).</p><pre><code class="language-julia">sim_result = leftjoin(sim_result1, sim_result2, 
    on=[:r, :thresh, :num_sim],
    renamecols= &quot;_0&quot; =&gt; &quot;_1&quot;
);

sim_result.num_dis = sim_result.num_alt_0 + sim_result.num_alt_1;
sim_result.num_false_dis = sim_result.num_alt_0;
sim_result.fdr = sim_result.num_false_dis ./ sim_result.num_dis;

sim_result.type1_error = sim_result.num_alt_0 ./ sim_result.num_sim;
#sim_result.type2_error = 1 .- sim_result.num_alt_1 ./ sim_result.num_sim;
sim_result.power = sim_result.num_alt_1 ./ sim_result.num_sim;

sim_result = sim_result |&gt;
    df -&gt; select(df, [:delta_1, :r, :thresh, :num_sim, :num_null_0, :num_alt_0, 
        :num_null_1, :num_alt_1, :type1_error, :power, :fdr]);</code></pre><pre><code class="language-julia">sim_result.num_dis = sim_result.num_alt_0 + sim_result.num_alt_1;
sim_result.num_false_dis = sim_result.num_alt_0;
sim_result.fdr = sim_result.num_false_dis ./ sim_result.num_dis;

sim_result.type1_error = sim_result.num_alt_0 ./ sim_result.num_sim;
sim_result.type2_error = 1 .- sim_result.num_alt_1 ./ sim_result.num_sim;</code></pre><pre><code class="language-julia">sim_result = sim_result |&gt;
    df -&gt; select(df, [:delta_1, :r, :thresh, :num_sim, :num_alt_0, :num_alt_1, :type1_error, :power, :fdr]);</code></pre><p>Examples from merged dataframe:</p><pre><code class="language-julia">sim_result |&gt;
    df -&gt; filter(
        x -&gt; ((x.delta_1 == 0.1) .&amp; (x.r == 0.707)) .|
             ((x.delta_1 == 0.1) .&amp; (x.r == 1.0)) .|
             ((x.delta_1 == 0.3) .&amp; (x.r == 1.0))
            , df) |&gt;
    df -&gt; sort(df, [:delta_1, :r, :thresh]) |&gt;
    printtable</code></pre><pre><code class="language-none">| delta_1 |     r | thresh | num_sim | num_alt_0 | num_alt_1 | type1_error |  power |       fdr |
|---------|-------|--------|---------|-----------|-----------|-------------|--------|-----------|
|     0.1 | 0.707 |    3.0 |    5000 |       311 |       568 |      0.0622 | 0.1136 |  0.353811 |
|     0.1 | 0.707 |    5.0 |    5000 |       288 |       812 |      0.0576 | 0.1624 |  0.261818 |
|     0.1 | 0.707 |    7.0 |    5000 |       238 |      1335 |      0.0476 |  0.267 |  0.151303 |
|     0.1 | 0.707 |   10.0 |    5000 |       181 |      2102 |      0.0362 | 0.4204 | 0.0792816 |
|     0.1 |   1.0 |    3.0 |    5000 |       338 |       542 |      0.0676 | 0.1084 |  0.384091 |
|     0.1 |   1.0 |    5.0 |    5000 |       282 |       810 |      0.0564 |  0.162 |  0.258242 |
|     0.1 |   1.0 |    7.0 |    5000 |       218 |      1329 |      0.0436 | 0.2658 |  0.140918 |
|     0.1 |   1.0 |   10.0 |    5000 |       210 |      2035 |       0.042 |  0.407 | 0.0935412 |
|     0.3 |   1.0 |    3.0 |    5000 |       338 |      2399 |      0.0676 | 0.4798 |  0.123493 |
|     0.3 |   1.0 |    5.0 |    5000 |       282 |      3843 |      0.0564 | 0.7686 | 0.0683636 |
|     0.3 |   1.0 |    7.0 |    5000 |       218 |      4762 |      0.0436 | 0.9524 | 0.0437751 |
|     0.3 |   1.0 |   10.0 |    5000 |       210 |      4990 |       0.042 |  0.998 | 0.0403846 |</code></pre><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><ol><li>Schönbrodt, Felix D., Eric-Jan Wagenmakers, Michael Zehetleitner, and Marco Perugini. &quot;Sequential hypothesis testing with Bayes factors: Efficiently testing mean differences.&quot; Psychological methods 22, no. 2 (2017): 322.</li><li>Deng, Alex, Jiannan Lu, and Shouyuan Chen. &quot;Continuous monitoring of A/B tests without pain: Optional stopping in Bayesian testing.&quot; In 2016 IEEE international conference on data science and advanced analytics (DSAA), pp. 243-252. IEEE, 2016.</li><li>Rouder, Jeffrey N. &quot;Optional stopping: No problem for Bayesians.&quot; Psychonomic bulletin &amp; review 21, no. 2 (2014): 301-308.</li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../type_s_error/">« Type S Error in Fixed Horizon and Sequential Testing Experiment</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Saturday 20 March 2021 02:09">Saturday 20 March 2021</span>. Using Julia version 1.5.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
